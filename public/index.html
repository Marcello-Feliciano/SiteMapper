<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Floorplan with Rotatable Cones</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #f0f0f0;
    }
    svg {
      width: 100vw;
      height: 100vh;
      touch-action: none;
      background: white;
    }
    .rotation-handle {
      fill: #ff6600;
      stroke: #fff;
      stroke-width: 2px;
      cursor: grab;
    }
  </style>
</head>
<body>
  <input type="file" id="importBtn" accept=".json" />
  <button id="exportBtn">Export JSON</button>
  
  <svg id="floorplan"></svg>

  <script>
    const svg = document.getElementById('floorplan');
    let floorplanImage;
    let activeGroup = null;
    let dragOffset = {x:0, y:0};
    let rotationTarget = null;
    let centerPoint = null;

    const iconData = [
      {type: 'camera', src: 'camera.png'},
      {type: 'projector', src: 'projector.png'},
      {type: 'door', src: 'door.png'},
    ];

    // Load floorplan background
    function loadFloorplan(src) {
      if (floorplanImage) floorplanImage.remove();
      floorplanImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
      floorplanImage.setAttribute('href', src);
      floorplanImage.setAttribute('x', 0);
      floorplanImage.setAttribute('y', 0);
      floorplanImage.setAttribute('width', '100%');
      floorplanImage.setAttribute('height', '100%');
      svg.prepend(floorplanImage);
    }

    // Create cone shape for camera/projector
    function createCone() {
      const cone = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      cone.setAttribute('d', 'M0,0 L100,-50 A100,100 0 0,1 100,50 Z');
      cone.setAttribute('fill', 'rgba(255,165,0,0.5)');
      cone.setAttribute('transform', 'translate(32,32)');
      return cone;
    }

    // Create rotation handle
    function createRotationHandle() {
      const handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      handle.setAttribute('r', 8);
      handle.setAttribute('cx', 132);
      handle.setAttribute('cy', 0);
      handle.classList.add('rotation-handle');
      return handle;
    }

    // Add icon to SVG
    function addIcon(type, x, y, rotation=0) {
      const data = iconData.find(i => i.type === type);
      if (!data) return;

      const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      group.setAttribute('transform', `translate(${x},${y})`);

      const icon = document.createElementNS('http://www.w3.org/2000/svg', 'image');
      icon.setAttribute('href', data.src);
      icon.setAttribute('width', 64);
      icon.setAttribute('height', 64);

      group.appendChild(icon);

      if (type === 'camera' || type === 'projector') {
        const cone = createCone();
        cone.setAttribute('transform', `translate(32,32) rotate(${rotation})`);
        group.appendChild(cone);

        const handle = createRotationHandle();
        handle.setAttribute('transform', `rotate(${rotation})`);
        group.appendChild(handle);
      }

      svg.appendChild(group);

      // Dragging logic
      group.addEventListener('pointerdown', e => {
        if (e.target.classList.contains('rotation-handle')) {
          rotationTarget = group;
          centerPoint = {x: x+32, y: y+32};
        } else {
          activeGroup = group;
          const [gx, gy] = getGroupTranslate(group);
          dragOffset.x = e.clientX - gx;
          dragOffset.y = e.clientY - gy;
        }
        e.stopPropagation();
      });

      // Double click to delete
      let lastTap = 0;
      group.addEventListener('pointerup', e => {
        const now = Date.now();
        if (now - lastTap < 300) {
          group.remove();
        }
        lastTap = now;
      });
    }

    function getGroupTranslate(group) {
      const transform = group.getAttribute('transform');
      const match = /translate\(([^,]+),([^,]+)\)/.exec(transform);
      return match ? [parseFloat(match[1]), parseFloat(match[2])] : [0, 0];
    }

    // Pointer move handler
    svg.addEventListener('pointermove', e => {
      if (activeGroup) {
        const newX = e.clientX - dragOffset.x;
        const newY = e.clientY - dragOffset.y;
        activeGroup.setAttribute('transform', `translate(${newX},${newY})`);
      }
      if (rotationTarget && centerPoint) {
        const dx = e.clientX - centerPoint.x;
        const dy = e.clientY - centerPoint.y;
        const angle = (Math.atan2(dy, dx) * 180 / Math.PI);
        const cone = rotationTarget.querySelector('path');
        const handle = rotationTarget.querySelector('circle.rotation-handle');
        cone.setAttribute('transform', `translate(32,32) rotate(${angle})`);
        handle.setAttribute('transform', `rotate(${angle})`);
      }
    });

    // Pointer up handler
    svg.addEventListener('pointerup', () => {
      activeGroup = null;
      rotationTarget = null;
      centerPoint = null;
    });

    // Export JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      const icons = [];
      svg.querySelectorAll('g').forEach(group => {
        const [x, y] = getGroupTranslate(group);
        const img = group.querySelector('image');
        const type = iconData.find(i => i.src === img.getAttribute('href')).type;
        let rotation = 0;
        if (type === 'camera' || type === 'projector') {
          const cone = group.querySelector('path');
          const rotMatch = /rotate\(([^)]+)\)/.exec(cone.getAttribute('transform'));
          rotation = rotMatch ? parseFloat(rotMatch[1]) : 0;
        }
        icons.push({type, x, y, rotation});
      });
      const data = JSON.stringify(icons);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'layout.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import JSON
    document.getElementById('importBtn').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const icons = JSON.parse(reader.result);
        svg.querySelectorAll('g').forEach(el => el.remove());
        icons.forEach(i => addIcon(i.type, i.x, i.y, i.rotation));
      };
      reader.readAsText(file);
    });

    // Example setup
    loadFloorplan('verkada-updated-floorplans.png');
    addIcon('camera', 100, 100, 45);
    addIcon('projector', 300, 200, 90);
    addIcon('door', 500, 150);

  </script>
</body>
</html>
